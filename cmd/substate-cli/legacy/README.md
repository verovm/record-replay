# Ethereum Substate Recorder/Replayer
Ethereum substate recorder/replayer based on the paper:

**Yeonsoo Kim, Seongho Jeong, Kamil Jezek, Bernd Burgstaller, and Bernhard Scholz**: _An Off-The-Chain Execution Environment for Scalable Testing and Profiling of Smart Contracts_,  USENIX ATC'21

To build all programs, simply run `make all`.
You can find all executables including `geth` and our `substate-cli` in `build/bin/` directory.

## Substate Data Structures
There are 5 data structures stored in a substate DB:
1. `SubstateAccount`: account information (nonce, balance, code, storage)
2. `SubstateAlloc`: mapping of account address and `SubstateAccount`
3. `SubstateEnv`: information from block headers (block gasLimit, number, timestamp, hashes)
4. `SubstateMessage`: message for transaction execution
5. `SubstateResult`: result of transaction execution

5 values are required to replay transactions and validate results:
1. `InputAlloc`: alloc that is read during transaction execution
2. `Env`: block information required for transaction execution
3. `Message`: array with exactly 1 transaction
4. `OutputAlloc`: alloc that is generated by transaction execution
5. `Result`: execution result and receipt array with exactly 1 receipt

The first 2 bytes of a key in a substate DB represent different data types as follows:
1. `1s`: Substate, a key is `"1s"+N+T` with transaction index `T` at block `N`.
`T` and `N` are encoded in a big-endian 64-bit binary.
2. `1c`: EVM bytecode, a key is `"1c"+codeHash` where `codeHash` is Keccak256 hash of the bytecode.

## Record transaction substates
Here is a simple way how to record substates.
1. Download the unmodified Geth client that this repository is based on.
For example, you can find in release notes that record-replay `rr0.3.2` is based on Geth `v1.10.15`.
2. Sync **the unmodified Geth** up to the block which you want to record and replay.
Geth full/snap sync will download blocks from the genesis block.
3. Export blocks using **the unmodified Geth**.
For example, `geth export ethereum.blockchain` to export from the genesis block to the latest synced block.
4. Import the exported blocks using **the `geth import` from record-replay** from scratch.
For example, `geth --datadir new.ethereum import ethereum.blockchain` to import and record the exported blocks from the unmodified Geth.

If you want to record a specific range of blocks `X-Y`, you need the (unmodified) Geth database whose head block is `X-1`, and blocks `X-Y` exported to a file.
If you don't have the Geth database at block `X-1`, then you need to export blocks up to `X-1` with the unmodified Geth, and import it from scratch again.

The output directory specified by `--substatedir` (default: `substate.ethereum`) is the substate DB.
The directory is a single LevelDB instance, so you must read or write the substate DB with `github.com/syndtr/goleveldb` module.
The substate DB may be corrupted if you directly write or modify any files in the directory.
Do not use LevelDB library for other languages (C++, Python, etc.) because they are incompatible with the goleveldb module.

## Replay transactions
`substate-cli replay` executes transaction substates in a given block range.
If `substate-cli replay` finds an execution result that is not equivalent to the recorded result,
it returns an error immediately.

For example, if you want to replay transactions from block 1,000,001 to block 2,000,000 in `substate.ethereum`:
```bash
./substate-cli replay --block-segment 1000001-2000000
```
In `--block-segment`, you can use `_` as a digit separator in block segment like `1_000_001-2_000_000`.
You can use SI unit suffix `k` and `M` to `--block-segment` for shorter notations like `1_000-2_000k` or `1-2M`.
```bash
./substate-cli replay --block-segment 1-2M
```

Here are command line options for `substate-cli replay`:
```
NAME:
   substate-cli replay - replay transactions and check output consistency

USAGE:
   substate-cli replay [command options] [arguments...]

DESCRIPTION:
   
   substate-cli replay executes transactions in the given block segment
   and check output consistency for faithful replaying.

OPTIONS:
   
          --workers value                (default: 4)
                Number of worker threads (goroutines), 0 for current CPU physical cores
   
          --skip-transfer-txs            (default: false)
                Skip executing transactions that only transfer ETH
   
          --skip-call-txs                (default: false)
                Skip executing CALL transactions to accounts with contract bytecode
   
          --skip-create-txs              (default: false)
                Skip executing CREATE transactions
   
          --substatedir value            (default: "substate.ethereum")
                Data directory for substate recorder/replayer
   
          --block-segment value         
                Single block segment (e.g. 1001, 1_001, 1_001-2_000, 1-2k, 1-2M)
   
          --help, -h                     (default: false)
                show help

```

For example, if you want 32 workers to replay transactions except CREATE transactions:
```bash
./substate-cli replay --block-segment 1-2M --workers 32 --skip-create-txs
```

If you want to replay only CALL transactions and skip the other types of transactions:
```bash
./substate-cli replay --block-segment 1-2M --skip-transfer-txs --skip-create-txs
```

If you want to use a substate DB other than `substate.ethereum` (e.g. `/path/to/substate_db`):
```bash
./substate-cli replay --block-segment 1-2M --substatedir /path/to/substate_db
```

### Hard-fork assessment
To assess hard-forks with prior transactions, use `substate-cli replay-fork` command. Run `./substate-cli replay-fork --help` for more details:

```
NAME:
   substate-cli replay-fork - replay transactions with the given hard fork and compare results

USAGE:
   substate-cli replay-fork [command options] [arguments...]

DESCRIPTION:
   
   substate-cli replay executes transactions in the given block segment
   with the given hard fork config and report output comparison results.

OPTIONS:
   
          --workers value                (default: 4)
                Number of worker threads (goroutines), 0 for current CPU physical cores
   
          --skip-transfer-txs            (default: false)
                Skip executing transactions that only transfer ETH
   
          --skip-call-txs                (default: false)
                Skip executing CALL transactions to accounts with contract bytecode
   
          --skip-create-txs              (default: false)
                Skip executing CREATE transactions
   
          --hard-fork value              (default: 12965000)
                Hard-fork block number, won't change block number in Env for NUMBER
                instruction
                    1: Frontier
                    1150000: Homestead
                    2463000: Tangerine Whistle
                  
                2675000: Spurious Dragon
                    4370000: Byzantium
                    7280000: Constantinople +
                Petersburg
                    9069000: Istanbul
                    12244000: Berlin
                    12965000: London
   
          --substatedir value            (default: "substate.ethereum")
                Data directory for substate recorder/replayer
   
          --block-segment value         
                Single block segment (e.g. 1001, 1_001, 1_001-2_000, 1-2k, 1-2M)
   
          --help, -h                     (default: false)
                show help
```

## Substate DB manipulation
`substate-cli db-*` commands are additional commands to directly manipulate substate DBs.

### `db-upgrade`
`substate-cli db-upgrade` command converts the old DB layout (`stage1-substate`) used for the USENIX ATC'21 paper to the latest DB layout (`substate.ethereum`).
```
./substate-cli db-upgrade --old-path stage1-substate --new-path substate.ethereum
```

### `db-clone`
`substate-cli db-clone` command reads substates of a given block range and copies them in a substate DB clone.
```
./substate-cli db-clone --src-path srcdb --dst-path dstdb --block-segment 1-2M --workers 0
```

### `db-compact`
`substate-cli db-compact` command compacts any LevelDB instance including the substate DB.
```
./substate-cli db-compact --substatedir substate.ethereum
```

## Debugging replayer
You may instrument EVM in our replayer instead of the P2P client to speed up dynamic analysis on EVM bytecode.
In this case, modify and run `substate-cli replay` which checks the EVM output with the recorded output.
If those two outputs are different in `substate-cli replay`, it will print substates formatted in JSON and terminate.
In this case, use `--workers=1` option for sequential transaction execution and identify the block N that causes the problem.
Then, add code that prints values for debugging or use debugging tools.

You may modify EVM specification and want to see the effects of the updates.
It also means that you don't expect that all transactions are faithfully replayed.
In this case, modify and run `substate-cli replay-fork` which checks differences in the outputs and reports them.
